/**
 * @author Holmes Bryant <webbmaastaa@gmail.com>
 * @license GPL-3.0
 */
export default class WijitForm extends HTMLElement{#t=!1;#e="dialog-message";#n={};#r=!1;#i=!1;#o=!0;#s=!0;#a="json";#l;#c;#m;errorElems;successElems;waitingElems;default={success:"<h3>Submission Received</h3><p>Thank you!</p>",error:"<h3>Oopsie!</h3><p>There was an error. Your submission was not received.</p>",waiting:"<h1>Please Wait...</h1>"};dialog;testing=!1;static observedAttributes=["custom-css","dialog-message-id","error","fetch-options","force-error","modal","reset-form","response","success","waiting"];constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='<style id="wijit-form-css">@layer wijit-form {html, body * { box-sizing: border-box; }wijit-form {    --bg1: rgb(250,250,250);    --bg2: rgb(245,245,245);    --bg3: white;    --text: rgb(60,60,60);    --border: silver;    --fail: hsl(6, 93%, 80%);    --pass: hsl(112, 70%, 75%);    --accent: lightskyblue;    --min: 2.5rem;    --pad: .25rem;    background-color: var(--bg1);    border-radius: 10px;    color: var(--text);    display: inline-block;    padding: 1rem;    width: 100%;    overflow: auto;}@media (prefers-color-scheme: dark) { wijit-form {        --text: rgb(240,240,240);        --bg1: rgb(35,35,35);        --bg2: rgb(40,40,40);        --bg3: rgb(60,60,60);    --accent: dodgerblue;        --border: dimgray; }    }}                 wijit-form details > *,    wijit-form fieldset,    wijit-form section    { background-color: var(--bg2); }    wijit-form button,    wijit-form input,    wijit-form progress,    wijit-form select,    wijit-form textarea    { background-color: var(--bg3); }    wijit-form hr    { background-color: silver; }    wijit-form .primary,    wijit-form option:checked    { background-color: var(--accent); }    wijit-form progress::-webkit-progress-value    { background-color: var(--accent); }wijit-form progress::-moz-progress-bar{ background-color: var(--accent); }    wijit-form .error    { background-color: var(--fail); }    wijit-form .success    { background-color: var(--pass); }        /****** Borders / Outlines ******/        wijit-form button,    wijit-form fieldset,    wijit-form input,    wijit-form input[type="checkbox"]::before,    wijit-form input[type="radio"]::before,    wijit-form progress,    wijit-form select,    wijit-form textarea,    wijit-form .error,    wijit-form .success    { border: 1px solid var(--border); }    wijit-form option    { border-bottom: 1px solid var(--border); }    wijit-form hr,    wijit-form option:last-child    { border: none; }    wijit-form input:user-valid:not([type="submit"]):not([type="reset"])    { border-color: var(--pass) }    wijit-form :user-invalid    { border-color: var(--fail) }wijit-form button,wijit-form fieldset,wijit-form hr,wijit-form input,wijit-form input[type="checkbox"]::before,wijit-form option,wijit-form progress,wijit-form progress::-webkit-progress-value,wijit-form progress::-webkit-progress-bar,wijit-form section,wijit-form select,wijit-form textarea,wijit-form .error,wijit-form .success{ border-radius: .5rem; }wijit-form input[type="radio"]{ border-radius: 50%; }wijit-form option{ border-radius: 0; }wijit-form option:first-child{ border-radius: .5rem .5rem 0 0; }wijit-form option:last-child{ border-radius: 0 0 .5rem .5rem; }    wijit-form :focus-visible    {    border-color: transparent;    outline: 1px solid var(--accent);    }    .success    { border-color: var(--pass); }    .error    { border-color: var(--fail); }                wijit-form input    { accent-color: var(--accent); }                wijit-form label.required:after    { color: var(--fail) }    wijit-form button,    wijit-form input,    wijit-form fieldset,    wijit-form label,    wijit-form legend,    wijit-form option,    wijit-form select,    wijit-form textarea    { color: var(--text); }    wijit-form option,    wijit-form button,    wijit-form input,    wijit-form fieldset,    wijit-form label,    wijit-form legend,    wijit-form option,    wijit-form select,    wijit-form textarea    {        font-size: 1rem;        letter-spacing: .1rem;    }    wijit-form input[type="checkbox"]::before,    wijit-form input[type="radio"]::before    {    font-size: 2.5rem;    line-height: 2.4rem;    }    wijit-form label.required    { font-size: small }    wijit-form button,    wijit-form input[type="reset"],    wijit-form input[type="submit"],    wijit-form label,    wijit-form legend,    wijit-form option,    wijit-form .error,    wijit-form .success    { font-weight:bold; }    wijit-form .error,    wijit-form .success    { text-align: center; }                wijit-form  button:hover,    wijit-form input[type="submit"]:hover,    wijit-form input[type="reset"]:hover,    wijit-form option:hover    { box-shadow: 2px 2px 5px black; }    wijit-form button:active,    wijit-form input[type="submit"]:active,    wijit-form input[type="reset"]:active,    wijit-form option:active,    wijit-form option:checked    { box-shadow: inset 2px 2px 5px black; }                wijit-form input[type="checkbox"],    wijit-form input[type="radio"],    wijit-form input[type="color"],    wijit-form input[type="range"],    wijit-form input[type="reset"],    wijit-form input[type="submit"],    wijit-form label,    wijit-form button,    wijit-form select    { cursor: pointer; }    wijit-form [disabled]    { cursor: not-allowed; }                wijit-form button,    wijit-form input[type=submit],    wijit-form input[type=reset] {    margin: 1rem;    }wijit-form fieldset,wijit-form section {display: flex;flex-direction: column;flex-wrap: wrap;gap: 0.5rem;overflow: auto;  min-inline-size: 200px;}wijit-form div {align-items: stretch;display: flex;flex-direction: column;flex-wrap: wrap;gap: 0.5rem;justify-content: center;}wijit-form div.row{ align-items: center; }wijit-form div > *,wijit-form fieldset > *,wijit-form section > *{ flex: 1; }wijit-form button,wijit-form input,wijit-form select {max-height: var(--min);    min-height: var(--min);    min-width: var(--min);    padding: var(--pad);}wijit-form hr {min-width: 100%;max-height: 5px;}wijit-form .row > hr {min-width: 5px;margin: 0;max-width: 5px;max-height: 100%;}    wijit-form input[type="checkbox"],    wijit-form input[type="radio"] {    appearance: none;    }    wijit-form input[type="checkbox"]:checked:after,    wijit-form input[type="radio"]:checked:after {    align-items: center;    display: flex;    font-size: var(--min);    font-weight: bold;    height: 100%;    line-height: 1rem;    justify-content: center;    }    wijit-form input[type="checkbox"]:checked:after    { content: "✔"; }    wijit-form input[type="radio"]:checked:after    { content: "⬤"; }    wijit-form input[type="color"],    wijit-form input[type="checkbox"],    wijit-form input[type="radio"] {    flex: 0;    flex-basis: var(--min);    padding: 0;    width: var(--min);    }  wijit-form input[type=range] {-webkit-appearance: none;-moz-appearance: none;appearance: none;inline-size: 100%;min-height: 5px;max-height: 5px;max-width: 95%;}wijit-form input[type="range"]::-webkit-slider-runnable-track {}wijit-form input[type="range"]::-webkit-slider-thumb {width: 35px;height: 35px;}wijit-form input[type="range"]::-moz-range-thumb {width: 35px;height: 35px;}wijit-form label {flex: 0;white-space: nowrap;}wijit-form option {padding: 1rem;}wijit-form progress {-webkit-appearance: none;-moz-appearance: none;appearance: none;inline-size: 100%;min-height: 1rem;}wijit-form progress::-webkit-progress-value{ min-height: 1rem; }wijit-form section + section{ margin: 1rem 0; }    wijit-form textarea    {    min-height: 5rem;    min-width: 10rem;    padding: var(--pad);    width: 100%;    }    wijit-form .required:after {    content: "*";    font-size: x-large;    vertical-align: super;    }    wijit-form .center {justify-content: center;align-content: center;}wijit-form .center > *{ flex: 1; }wijit-form .end {align-content: flex-end;justify-content: flex-end;}wijit-form .reverse.end {align-content: flex-start;justify-content: flex-start;}wijit-form .end > *{ flex: 1; }wijit-form .nowrap{ flex-wrap: nowrap}wijit-form .reverse{ flex-direction: column-reverse; }wijit-form .row{ flex-direction: row; }wijit-form .row.reverse{ flex-direction: row-reverse; }wijit-form .start {align-content: flex-start;justify-content: flex-start;}wijit-form .reverse.start {align-content: flex-end;justify-content: flex-end;}wijit-form .start > *{ flex: 1; }</style><style>:host {--fail: darksalmon;--pass: limegreen;}button {border-color: var(--border);border-radius: 5px;cursor: pointer;font-size: large;font-weight: bold;outline-color: var(--accent);padding: .5rem;}button:hover,button:focus {box-shadow: 2px 2px 5px black;}button:active {box-shadow: inset 2px 2px 5px black;}dialog {background: transparent;border: none;box-sizing: border-box;color: var(--text);outline: none;text-align: center;}dialog::backdrop {background-color: white;color: black;opacity: 0.75;}dialog.modeless {accent-color: transparent;backdrop-filter: blur(.3rem);height: 100%;outline: none;padding: 0;top: 0;width: 100%;}dialog.modeless[open] {display: table;}.hidden{ display: none; }#dialog-message {background-color: var(--bg3);border: 1px solid var(--border);border-radius: 10px;display: table-cell;padding: 1rem;vertical-align: middle;}dialog.modeless #dialog-message {transition: all 1s;}#dialog-message.waiting {background-color: transparent;border: none;margin: auto;padding: 0;width: auto;}#dialog-message.error {border-color: var(--fail);}#dialog-message.success {border-color: var(--pass);}#wrapper {position: relative;overflow: hidden;}@media (prefers-color-scheme: dark) {dialog::backdrop {background-color: black;color: white;}}</style><div id="wrapper"><slot></slot><slot name="dialog"><dialog class="modeless"><div id="dialog-message"><slot name="message"></slot></div><form method="dialog" class="hidden"><button>OK</button></form></dialog></slot></div><div hidden id="responses" style="display:none"><button aria-label="close" form="dialog-form">OK</button><slot name="waiting"></slot><slot name="success"></slot><slot name="error"></slot></div>',this.mainAbortController=new AbortController}connectedCallback(){this.form=this.querySelector("form"),this.dialog=this.querySelector("dialog")||this.shadowRoot.querySelector("dialog"),this.container=this.dialog.querySelector(`#${this.dialogMessageId}`),this.errorElems=this.querySelectorAll("[slot=error]"),this.successElems=this.querySelectorAll("[slot=success]"),this.waitingElems=this.querySelectorAll("[slot=waiting]"),this.customCss||this.addDefaultCss(),this.form&&this.form.addEventListener("submit",(t=>this.submitData(t)),{signal:this.mainAbortController.signal}),this.dialog.addEventListener("close",(t=>{this.reset&&this.resetFormElements(this.form)}),{signal:this.mainAbortController.signal}),this.addFocusListeners()}attributeChangedCallback(t,e,n){t.indexOf("-")>-1&&(t=(t=t.split("-").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join("")).replace(t.charAt(0),t.charAt(0).toLowerCase())),this[t]=n}disconnectedCallback(){this.mainAbortController.abort()}async submitData(t){let e,n;t.preventDefault();const r=new FormData(t.target),i="html"===this.response?"text/html":"application/json",o=this.setFetchOptions(t,i);if(this.testing||this.showDialog(this.waiting,null),-1===t.target.action.indexOf("false")?(e=t.target.action,this.#s=!0):this.#s=!1,"GET"===o.method||"HEAD"===o.method){let t=0;e+="?";for(const n of r.entries())e+=0===t?n.join("="):`&${n.join("=")}`,t++;e=encodeURI(e)}else o.body=r;if(this.#s){if(n=await this.fetchData(e,o),this.testing)return this.setMessage(n.data,n.status);this.showDialog(n.data,n.status)}else n=this.simulateServer(o),setTimeout((()=>{this.showDialog(n.data,n.status)}),1e3)}async fetchData(t,e){try{const n=await fetch(t,e),r=n.status,i=n.headers.get("Content-Type");return{data:i.includes("json")?await n.json():await n.text(),status:r}}catch(t){return{data:"<h1>Server Error</h1>",status:status}}}simulateServer(t){let e,n;const r=t.body,i="<p>This result is a simulation. No server side form processing was performed.";return t.data=Object.fromEntries(r.entries()),delete t.body,this.forceError?(n=500,"html"===this.response?(e="<h1>Error</h1><p>HTML response</p>",e+=i):e=t):(n=200,"html"===this.response?(e="<h1>Success</h1><p>HTML response</p>",e+=i):e=t),{data:e,status:n}}setFetchOptions(t,e){const n=this.fetchOptions?JSON.parse(JSON.stringify(this.fetchOptions)):{},r=t.target.getAttribute("method")||"POST";return n.method=r.toUpperCase(),n.headers=n.headers||{},n.headers.Accept=n.headers.Accept||e,n}showDialog(t,e){const{container:n,dialog:r,modal:i}=this,o=this.setMessage(t,e),s=this.dialog.querySelector("form[method=dialog]"),a=s.querySelector("input[type=submit], button");return o&&(n.innerHTML=o),n.append(s),e?(s.classList.remove("hidden"),a.focus()):s.classList.add("hidden"),i?(r.classList.remove("modeless"),r.showModal()):(r.classList.add("modeless"),r.show()),o}setMessage(t,e){const{waitingElems:n,errorElems:r,successElems:i,container:o}=this;let s,a,l;return this.clearMessage(),null===e?(s="waiting",a=n,o.classList.add("waiting")):e>399?(s="error",a=r,o.classList.add("error"),o.classList.remove("waiting")):(s="success",a=i,o.classList.add("success"),o.classList.remove("waiting")),null!==this[s]&&void 0!==this[s]?l="json"===this.response?this.replacePlaceholders(this[s],t):this[s]:a.length>0?("json"===this.response&&this.replaceNodeContents(a,t),a.forEach((t=>t.setAttribute("slot","message")))):l="html"===this.response?null===e?this.default[s]:t:this.default[s],l}replacePlaceholders(t,e){const n=/{{([^{}]+)}}/g;let r,i=t;for(;null!==(r=n.exec(i));){const t=r[1].split(".");let n=e;for(const e of t)if(n=n?.[e],void 0===n)break;i=i.replace(r[0],void 0===n?r[0]:JSON.stringify(n))}return i.replaceAll('"',"")}replaceNodeContents(t,e){const n=/{{([^{}]+)}}/g;for(const r of t){let t,i=r.innerHTML;for(;null!==(t=n.exec(i));){const n=t[1].split(".");let r=e;for(const t of n)if(r=r?.[t],void 0===r)break;i=i.replace(t[0],void 0===r?t[0]:r)}r.innerHTML=i}return t}addFocusListeners(){if(this.form)for(const t of this.form.elements)"textarea"!==t.localName&&t.addEventListener("focus",(()=>{"function"==typeof t.select&&t.select()}),{signal:this.mainAbortController.signal})}resetFormElements(t){const e=t.querySelectorAll("input, select, textarea");try{this.form.reset(),e[0].focus()}catch(t){console.debug(typeof this.form.reset,this.form),console.error(this)}}clearMessage(){this.container.classList.remove("error"),this.container.classList.remove("success");for(const t of this.waitingElems)t.setAttribute("slot","waiting");for(const t of this.errorElems)t.setAttribute("slot","error");for(const t of this.successElems)t.setAttribute("slot","success")}cleanHTML(t){const e=new Set(["p","span","h1","h2","h3","h4","h5","h6","b","strong","i","hr","br"]),n=new Set(["id","class","style"]),r=document.createElement("div");r.innerHTML=t;for(let t=r.childNodes.length-1;t>=0;t--){const i=r.childNodes[t];if(i.nodeType===Node.ELEMENT_NODE){if(!e.has(i.localName.toLowerCase())){r.replaceChild(document.createTextNode(i.textContent),i);continue}const t=Array.from(i.attributes).filter((t=>n.has(t.name)));i.attributes.length=0;for(const e of t)i.setAttribute(e.name,e.value)}}return r.innerHTML}validateJson(t){try{return JSON.parse(t)}catch(e){try{const e=t.replace(/['"<>;\s\r?()]/g,"").replace(/([\w:\/\\]+)/g,'"$&"');return JSON.parse(e)}catch(t){return!1}}}addDefaultCss(){document.head.querySelector("#wijit-form-css")||document.head.append(this.defaultCss())}defaultCss(){return this.shadowRoot.querySelector("#wijit-form-css")}get customCss(){return this.#t}set customCss(t){switch(t){case"":case"true":t=!0,this.addDefaultCss();break;default:t=!1,document.head.querySelector("style#wijit-form-css")&&style.remove()}this.#t=t}get dialogMessageId(){return this.#e}set dialogMessageId(t){this.#e=t}get fetchOptions(){return this.#n}set fetchOptions(t){t=this.validateJson(t),this.#n=null===t?{}:t}get forceError(){return this.#r}set forceError(t){let e=this.form.querySelector("input[name=fail]");switch(t.toLowerCase()){case"":case"true":case!0:t=!0,e||(e=document.createElement("input"),e.name="fail",e.value="true",e.type="hidden",this.form.append(e));break;default:t=!1,e&&e.remove()}this.#r=t}get modal(){return this.#i}set modal(t){switch(t.toLowerCase()){case"":case"true":t=!0;break;default:t=!1}this.#i=t}get resetForm(){return this.#o}set resetForm(t){switch(t.toLowerCase()){case"":case"true":t=!0;break;default:t=!1}this.#o=t}get response(){return this.#a}set response(t){this.#a=t.toLowerCase()}get error(){return this.#l}set error(t){if("null"===(t=this.cleanHTML(t)))t=null;this.#l=t}get success(){return this.#c}set success(t){if("null"===(t=this.cleanHTML(t)))t=null;this.#c=t}get waiting(){return this.#m}set waiting(t){if("null"===(t=this.cleanHTML(t)))t=null;this.#m=t}}document.addEventListener("DOMContentLoaded",customElements.define("wijit-form",WijitForm));
