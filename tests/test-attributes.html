<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Integration Tests</title>
	<style>
		#container {
			height: calc(100vmin - 200px);
			border: 1px solid gray;
			overflow: auto;
		}

		h1 {
			font-size: 18px;
			margin: 0;
		}

		label { display: block; }

		.pass {
			border: 2px solid lime;
			background: palegreen;
		}

		.fail {
			border: 2px solid darkred;
			background: lightsalmon;
		}

		.hidden { display: none; }

		.row {
			display: flex;
			flex-wrap: wrap;
			align-items: center;
			justify-items: flex-start;
			align-content: flex-start;
			justify-content: flex-start;
		}

		b { flex: 0 0 5rem; }

		textarea {
			flex: 2;
			width: 100%;
			overflow-y: hidden;
			overflow-x: auto;
			border: 1px solid gray;
		}
	</style>
</head>
<body>
	<h1>Testing all attribute combinations and submitting to test server</h1>
	<p>
		<label><span id="current">1</span> of <span id="total">x</span></label>
		<progress id="progress" min="0"></progress>
	</p>
	<p>
		<button id="start" onclick="start()">Start</button>
		<button id="stop" onclick="stop()">Stop</button>
		<button id="pause" class="hidden" onclick="pause()">Pause</button>
		<button id="reload" class="hidden" onclick="reload()">Reload</button>
	</p>
	<div id="container"></div>

	<script type="module">
		import WijitForm from "/wijit-form.js";
		import Tester from "/tests/tester.js";

		let tester, instance, combos;
		let endTest = false;
		let paused = false;
		const stopOnError = true;
		const abortController = new AbortController();
		const startBtn = document.querySelector('#start');
		const stopBtn = document.querySelector('#stop');
		const pauseBtn = document.querySelector('#pause');
		const reloadBtn = document.querySelector('#reload');
		const progress = document.querySelector('#progress');
		const totalElem = document.querySelector('#total');
		const inputValue = 'UserName';

		// responses from server
		const server = {
			success: {
				html: '<h3>HTML</h3><p>Success message from server</p>',
				json: 'status'
			},
			error: {
				html: '<h3>HTML</h3><p>Error message from server</p>',
				json: 'status'
			}
		}

		const options = {
			"fetch-options": [null, '{mode:same-origin}'],
			"force-error": ['true', 'false'],
			response: ['html', 'json'],
			success: [null, 'success user', 'success {{data.name}}'],
			error: [null, 'error user', 'error {{data.name}}'],
			modal: ['true', 'false'],
			reset: ['true', 'false']
		};

		function start () {
			const tag = document.querySelector('wijit-form');
			if (tag) tag.remove();

			const component = new WijitForm ();
			const form = addForm();
			const customEvent = new CustomEvent ('testEvent', {bubbles:true, cancelable:true, composed:true});

			tester = new Tester(component);
			instance = tester.instance;
			combos = tester.getAllCombinations (options);
			progress.setAttribute ('max', combos.length);
			totalElem.innerText = combos.length;

			instance.append (form);
			instance.testing = true;
			document.body.append (instance);
			form.dispatchEvent (customEvent)
			form.addEventListener ('testEvent', testFormSubmission(customEvent), {signal: abortController.signal});
			startBtn.classList.add('hidden');
			pauseBtn.classList.remove('hidden');
		}

		function stop () {
			abortController.abort();
			endTest = true;
			pauseBtn.classList.add('hidden');
			stopBtn.classList.add('hidden');
			reloadBtn.classList.remove('hidden');
		}

		function pause () {
			paused = !paused;
			pauseBtn.textContent = paused ? 'Resume' : 'Pause';

		}

		function reload() {
			location.reload();
		}

		function addForm() {
			const form = document.createElement ('form');
			const input = document.createElement ('input');
			const checkbox = document.createElement ('input');
			form.action = 'test-server.php';
			checkbox.type = 'checkbox';
			input.name = 'name';
			checkbox.name = 'test';
			input.value = inputValue;
			checkbox.value = 'true';
			checkbox.checked = true;
			form.append (input);
			form.append (checkbox);
			return form;
		}

		async function pauseIfNeeded () {
			if (paused) {
				await new Promise (resolve => {
					pauseBtn.addEventListener('click', resolve);
				});
				paused = false;
			}
		}

		function updateProgress (count) {
			const label = document.querySelector('#current');
			progress.value = count;
			label.innerText = count;
		}

		function addResult (result, expected, combo, currentIdx) {
			const div = document.querySelector('#container');
			const item = document.createElement('div');
			const options = JSON.stringify(combo);
			const current = `<div><b>${currentIdx}:</b> ${options}</div>`
			const expectedMsg = `<div class="row"><b>Expected:</b> <textarea>${expected}</textarea></div>`;
			const resultMsg = `<div class="row"><b>Result:</b> <textarea>${result}</textarea></div>`;

			if (result === expected) {
				item.classList.add('pass');
			} else {
				item.classList.add('fail');
			}

			item.innerHTML = current + expectedMsg + resultMsg;
			div.prepend(item);

			if (result !== expected && stopOnError) {
				stop();
			}
		}

		async function testFormSubmission (event) {
			let i = 1;
			for (const combo of combos) {
				if (endTest) break;
				await pauseIfNeeded();
				tester.setAttributes(combo);
				const result = await instance.submitData(event);
				delete(combo.fetchOptionss);
				delete(combo.waiting);
				delete(combo.modal);
				delete(combo.reset);
				const expected = testResult (combo);
				addResult(result, expected, combo, i);
				updateProgress(i);
				i++;
			}
		}

		function testResult (combo) {
			let expected;

			if (combo["force-error"] === "false") {
				expected = testSuccess (combo);
			} else if (combo["force-error"] === "true") {
				expected = testError (combo);
			}

			return expected;
		}

		function testSuccess (combo) {
			let expected;
			if (combo.response === "html") {
				if (combo.success === null) {
					// server message
					expected = server.success.html;
				} else {
					// custom message
					expected = combo.success;
				}
			} else if (combo.response === "json") {
				if (combo.success === null) {
					expected = instance.default.success;
				} else if (combo.success.indexOf ('{{') > -1) {
					expected = expected = `success ${inputValue}`;
				} else {
					expected = combo.success;
				}
			}

			return expected;
		}

		function testError (combo) {
			let expected;

			if (combo.response === "html") {
				if (combo.error === null) {
					// server message
					expected = server.error.html;
				} else {
					// custom msg
					expected = combo.error;
				}
			} else if (combo.response === "json") {
				if (combo.error === null) {
					// default message
					expected = instance.default.error;
				} else if (combo.error.indexOf ('{{') > -1) {
					// custom message with placeholders
					expected = `error ${inputValue}`;
				} else {
					// custom message without placeholders
					expected = combo.error;
				}
			}

			return expected;
		}

		window.start = start;
		window.stop = stop;
		window.pause = pause;
		window.reload = reload;
	</script>
</body>
</html>
