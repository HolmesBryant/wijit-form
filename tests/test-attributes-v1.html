<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Integration Tests</title>
	<style>
		#container {
			height: calc(100vmin - 200px);
			border: 1px solid gray;
			overflow: auto;
		}

		h1 {
			font-size: 18px;
			margin: 0;
		}

		label { display: block; }

		.pass {
			border: 2px solid lime;
			background: palegreen;
		}

		.fail {
			border: 2px solid darkred;
			background: lightsalmon;
		}
	</style>

</head>
<body>
	<h1>Testing all attribute combinations and submitting to test server</h1>
	<p>
		<label><span id="current">1</span> of <span id="total">x</span></label>
		<progress id="progress" min="0"></progress>
	</p>
	<p>
		<button onclick="start()">Start</button>
		<button onclick="stop()">Stop</button>
		<button id="pause-button" onclick="pause()">Pause</button>
	</p>
	<div id="container"></div>

	<script type="module">
		console.log('foo');
		import WijitForm from "/wijit-form.js";
		import Tester from "/tester.js";

		let tester, instance, combos;
		let endTest = false;
		let paused = false;
		const abortController = new AbortController();
		const pauseBtn = document.querySelector('#pause-button')
		const progress = document.querySelector('#progress');
		const totalElem = document.querySelector('#total');
		const inputValue = 'Some Name';

		// responses from server
		const server = {
			success: {
				html: '<h3>HTML</h3><p>Success message from server</p>',
				json: 'status'
			},
			error: {
				html: '<h3>HTML</h3><p>Error message from server</p>',
				json: 'status'
			}
		}

		const options = {
			"fetch-options": [null, '{mode:same-origin}'],
			"force-error": ['true', 'false'],
			response: ['html', 'json'],
			success: [null, 'success user', 'success {{data.name}}'],
			error: [null, 'error user', 'error {{data.name}}'],
			modal: ['true', 'false'],
			reset: ['true', 'false']
		};

		function start () {
			const component = new WijitForm ();
			const event = new CustomEvent ('testEvent', {bubbles:true, cancelable:true, composed:true});
			const form = document.createElement ('form');
			const input = document.createElement ('input');

			tester = new Tester(component);
			instance = tester.instance;
			combos = tester.getAllCombinations (options);
			progress.setAttribute ('max', combos.length);
			totalElem.innerText = combos.length;
			form.action = '/test-server.php';
			input.name = 'name';
			input.value = inputValue;
			form.append (input);
			instance.append (form);
			instance.testing = true;
			document.body.append (instance);
			form.dispatchEvent (event)
			form.addEventListener ('testEvent', testFormSubmission(event), {signal: abortController.signal});
		}

		function stop () {
			abortController.abort();
			endTest = true;
		}

		function pause () {
			paused = !paused;
			pauseBtn.textContent = paused ? 'Resume' : 'Pause';
		}

		async function pauseIfNeeded () {
			if (paused) {
				await new Promise (resolve => {
					pauseBtn.addEventListener('click', resolve);
				});
				paused = false;
			}
		}

		function updateProgress (count) {
			const label = document.querySelector('#current');
			progress.value = count;
			label.innerText = count;
		}

		function addResult (result, expected, currentIdx) {
			const div = document.querySelector('#container');
			const item = document.querySelector('div');
			expected = `<div><b>Expected:</b> ${expected}</div>`;
			result = `<div><b>Result:</b> ${result}</div>`;

			if (result === expected) {
				item.classList.add('pass');
			} else {
				item.classList.add('fail');
			}

			item.innerHTML = `<h4>${currentIdx}</h4>` + expected + result;
			// item.insertAdjacentHTML('afterbegin', expected);
			// item.insertAdjacentHTML('afterbegin', result);
			// item.insertAdjacentHTML('afterbegin', `<h4>${currentIdx}</h4>`);
			div.append(item);
		}

		async function testFormSubmission (event) {
			let i = 1;
			for (const combo of combos) {
				if (endTest) break;
				await pauseIfNeeded();
				tester.setAttributes(combo);
				const result = await instance.submitData(event);
				// delete(combo.fetchOptionss);
				// delete(combo.waiting);
				// delete(combo.modal);
				// delete(combo.reset);
				const expected = testResult (result, combo);
				addResult(result, expected, i);
				updateProgress(i);
				i++;
			}
		}

		function testResult (result, combo) {
			let expected;

			if (combo["force-error"] === "false") {
				expected = testSuccess (combo);
			} else if (combo["force-error"] === "true") {
				expected = testError (combo);
			}

			return expected;
		}

		function testSucccess (result, combo) {
			let expected;
			if (combo.response === "html") {
				if (combo.success === null) {
					expected = server.success.html;
				} else if (combo.success.indexOf ('{{') > -1) {
					expected = inputValue;
				} else {
					expected = combo.success;
				}
			} else if (combo.response === "json") {
				if (combo.success === null) {
					expected = instance.default.success;
				} else if (combo.success.indexOf ('{{') > -1) {
					expected = inputValue;
				} else {
					expected = combo.success;
				}
			}

			return expected;
		}

		function testError (result, combo) {
			let expected;
			if (combo.response === "html") {
				if (combo.error === null) {
					expected = server.error.html;
				} else if (combo.error.indexOf ('{{') > -1) {
					expected = inputValue;
				} else {
					expected = combo.error;
				}
			} else if (combo.response === "json") {
				if (combo.error === null) {
					expected = instance.default.error;
				} else if (combo.error.indexOf ('{{') > -1) {
					expected = inputValue;
				} else {
					expected = combo.error;
				}
			}

			return expected;
		}

		window.start = start;
		window.stop = stop;
		window.pause = pause;
	</script>
</body>
</html>
