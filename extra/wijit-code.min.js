/**
 * @author Holmes Bryant <webbmaastaa@gmail.com>
 * @license GPL-3.0
 */
export default class WijitCode extends HTMLElement{#t=new AbortController;#e=new AbortController;#i=!1;#n=!1;#s;#r=!1;#h="1";#o=!1;#l=0;#a=!1;static observedAttributes=["edit","highlight","inline","indent","line-numbers","palette"];constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`\n\t\t\t<style>\n\t\t\t\t:host {\n\t\t\t\t\t--indent: ${this.indent};\n\t\t\t\t\t--line-number-color: gray;\n\t\t\t\t\t--wrap: pre;\n\t\t\t\t\tdisplay: inline-block;\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\tvertical-align: middle;\n\t\t\t\t}\n\n\t\t\t\tdiv {\n\t\t\t\t\tposition: relative;\n\t\t\t\t\tfont-family: "Courier New", monospace;\n\t\t\t\t}\n\n\t\t\t\tpre {\n\t\t\t\t\tfont-family: monospace;\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\ttab-size: var(--indent);\n\t\t\t\t\twhite-space: var(--wrap);\n\t\t\t\t}\n\n\t\t\t\tsection {\n\t\t\t\t\tdisplay: grid;\n\t\t\t\t\tgap: .5rem;\n\t\t\t\t\tgrid-template-columns: max-content 1fr;\n\t\t\t\t}\n\n\t\t\t\ttextarea {\n\t\t\t\t\tall: inherit;\n\t\t\t\t\tbottom: 0;\n\t\t\t\t\tcaret-color: white;\n\t\t\t\t\tcolor: transparent;\n\t\t\t\t\tdisplay: block;\n\t\t\t\t\theight: 100%;\n\t\t\t\t\toverflow-y: hidden;\n\t\t\t\t\tposition: absolute;\n\t\t\t\t\ttab-size: var(--indent);\n\t\t\t\t\ttop: 0;\n\t\t\t\t\twidth: 100%;\n\t\t\t\t}\n\n\t\t\t\ttextarea:focus {\n\t\t\t\t\toutline: 2px dashed silver;\n\t\t\t\t}\n\n\t\t\t\t.hidden {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\n\t\t\t\t.inline {\n\t\t\t\t\tdisplay: inline;\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\twhite-space: nowrap;\n\t\t\t\t}\n\n\t\t\t\t#line-numbers {\n\t\t\t\t\tcolor: var(--line-number-color);\n\t\t\t\t\tfont-family: monospace;\n\t\t\t\t\twhite-space: pre-line;\n\t\t\t\t}\n\t\t\t</style>\n\n\t\t\t<section>\n\t\t\t\t<div id="line-numbers"></div>\n\t\t\t\t<div>\n\t\t\t\t\t<pre><slot></slot></pre>\n\t\t\t\t\t<textarea class="hidden" spellcheck="false"></textarea>\n\t\t\t\t</div>\n\t\t\t</section>\n\t\t`}connectedCallback(){const t=this.shadowRoot.querySelector("slot");this.contentNode=this.shadowRoot.querySelector("pre"),this.textContent=this.resetSpaces(this.getContent()),this.highlight&&this.highlightCode(),this.lineNumbers&&this.addLineNumbers(),t.addEventListener("slotchange",(()=>{this.updateIfNeeded()}),{signal:this.#t.signal})}attributeChangedCallback(t,e,i){this[t=t.replace(/-./g,(t=>t.toUpperCase()[1]))]=i}disconnectedCallback(){this.#t.abort(),this.#e.abort()}updateIfNeeded(t=500,e=this){const i=Date.now();this.#a?i-this.#l>t&&(this.#l=i,this.textContent=this.resetSpaces(this.getContent(e)),this.highlighter&&this.destroyHighlights(),this.highlight&&this.highlightCode(),this.lineNumbers&&this.addLineNumbers()):this.#a=!0}async highlightCode(t=this.highlight,e=this){try{return await this.highlighter.highlight(t,e.childNodes[0])}catch(t){throw t}}destroyHighlights(){try{return this.highlighter.removeAll()}catch(t){console.error(t)}}resetSpaces(t){this.needsUpdate=!1,t=t.replace(/^ +/gm,(t=>"\t".repeat(t.length))).trim();const e=t.split("\n"),i=e.at(-1).match(/^\s*/)[0].length,n=new RegExp(`^\\s{${i}}`,"g");return e.map((t=>t.replace(n,""))).join("\n")}getContent(t=this){let e,i;return"textarea"===t.localName?i=t.value:t.firstElementChild&&"textarea"===t.firstElementChild.localName?(e=t.querySelector("textarea"),i=e.value.replace("<\\","<"),e.remove()):i=this.convertHTML(t.innerHTML),i}convertHTML(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}addLineNumbers(){let t=1;const e=this.shadowRoot.querySelector("#line-numbers");e.textContent="";const i=this.textContent.split(/\r?\n/).length;for(;t<=i;t++)e.textContent+=t+"\n"}enableEdit(){const t=this.shadowRoot.querySelector("textarea");t.classList.remove("hidden"),t.value=this.textContent,this.interceptKeyPress(t),t.addEventListener("input",(t=>{this.updateIfNeeded(500,t.target)}),{signal:this.#e.signal})}disableEdit(){this.shadowRoot.querySelector("textarea").classList.add("hidden"),this.#e.abort()}interceptKeyPress(t){t.addEventListener("keydown",(t=>{if("Tab"===t.key){t.preventDefault();const e=t.target,i=e.selectionStart,n=e.selectionEnd,s=e.value.substring(0,i),r=e.value.substring(n);e.value=s+"\t"+r,e.selectionStart=e.selectionEnd=i+1;const h=new Event("input");e.dispatchEvent(h)}}),{signal:this.#e.signal})}get inline(){return this.#r}set inline(t){const e=this.shadowRoot.querySelector("pre");switch(t){case"false":case!1:t=!1,this.removeAttribute("inline"),e&&e.classList.remove("inline"),this.hasAttribute("line-numbers")&&(this.lineNumbers=this.getAttribute("line-numbers"));break;default:t=!0,e&&e.classList.add("inline"),this.lineNumbers=!1}this.#r=t}get indent(){return this.#h}set indent(t){this.style.setProperty("--indent",t),this.#h=t}get highlight(){return this.#n}set highlight(t){switch(t){case"false":case!1:t=!1;break;default:this.highlighter=this.highlighter||new Highlighter(this)}this.#n=t,this.contentNode&&this.updateIfNeeded()}get edit(){return this.#i}set edit(t){switch(t){case"false":case!1:this.#i=!1,this.contentNode&&this.disableEdit();break;default:this.#i=!0,this.contentNode?this.enableEdit():customElements.whenDefined(this.localName).then((t=>{this.enableEdit()}))}}get lineNumbers(){return this.#o}set lineNumbers(t){const e=this.shadowRoot.querySelector("#line-numbers");switch(t){case"false":case!1:this.#o=!1,e.textContent="";break;default:this.#o=!0,this.contentNode&&this.updateIfNeeded()}}get palette(){return!!this.highlighter&&this.highlighter.palette}set palette(t){this.highlighter?this.highlighter.palette=t:console.error("highlighter has not been initialized")}}
/**
 * @author Holmes Bryant <webbmaastaa@gmail.com>
 * @license GPL-3.0
 */
export class Highlighter{#d;container;suffix="_"+Math.random().toString(36).substring(2,15);defaultColors=new Map([["argument","hsl(32, 93%, 66%)"],["comment","hsl(221, 12%, 69%)"],["function","hsl(210, 50%, 60%)"],["keyword","hsl(300, 30%, 68%)"],["number","hsl(32, 93%, 66%)"],["operator","red"],["string","hsl(114, 31%, 68%)"],["variable","whitesmoke"],["tag","indianred"]]);constructor(t,e){return this.container=t,this.palette=e,this}async highlight(t="html",e){if(void 0===window.Highlight)throw new Error("Browser does not support CSS Custom Highlight API");e=e||this.container.childNodes[0]||document.createTextNode("");const i=`highlights${this.suffix}`;document.head.querySelector(`#${i}`)||document.head.append(this.getStyle());try{const i=await this.getSyntax(t);return this.highlightCode(i,e),!0}catch(t){throw console.error("Error loading Highlight Syntax: ",t),t}}async getSyntax(t="html"){if("string"==typeof t){let e=t;/^(http|\.|\/)/.test(t)||(e=`./syntax.${t}.js`);try{t=await import(e)}catch(t){throw t}}return t.default}highlightCode(t={},e){if(e.nodeType!==Node.TEXT_NODE)throw new Error(`Second argument must be a TEXT_NODE (3). Given nodeType is (${e.nodeType})`);let i;const n=e.textContent;for(const s of Object.keys(t)){const r=t[s];if(r){if(Array.isArray(r)){const t=[...new Set(r)].join("|"),s=new RegExp(`\\b(${t})\\b`,"g");i=this.setRanges(s,n,e)}else if(r instanceof Function)i=new Set(r(n,e));else{if(!(r instanceof RegExp))throw console.error(`Invalid syntax definition for ${s}: `,`"${r}"`),new Error(`Invalid syntax definition for ${s}`);i=this.setRanges(r,n,e)}this.setHighlight(i,s)}}return!0}setRanges(t,e,i){const n=new Set,s=e.matchAll(t);for(const t of s){const e=t.index,s=e+t[0].length,r=new Range;r.setStart(i,e),r.setEnd(i,s),n.add(r)}return n}getHighlights(){const t=new Map;return CSS.highlights.forEach(((e,i)=>{i.endsWith(this.suffix)&&t.set(i,e)})),t}setHighlight(t,e="test"){e+=this.suffix;const i=new Highlight(...t);try{return CSS.highlights.set(e,i),!0}catch(t){throw t}}getStyle(){const t=document.createElement("style");let e="";return t.id=`highlights${this.suffix}`,this.palette.forEach(((t,i)=>{e+=`::highlight(${i}${this.suffix}) { color: ${t}}\n`})),t.textContent=e,t}remove(t){CSS.highlights.delete(t+this.suffix)}removeAll(){return CSS.highlights.forEach(((t,e)=>{e.endsWith(this.suffix)&&CSS.highlights.delete(e)})),this.suffix}clearRegistry(){CSS.highlights.clear()}logRegistry(){CSS.highlights.forEach(((t,e)=>{console.log(e,t)}))}get palette(){return this.#d||this.defaultColors}set palette(t){let e;const i=document.head.querySelector(`#highlights${this.suffix}`);if(t&&""!==t&&void 0!==t)if(Array.isArray(t))e=new Map(t);else if(t instanceof Map)e=t;else try{t=JSON.parse(t),e=new Map(t)}catch(t){console.error(t)}else this.#d=null;this.#d=e;const n=this.getStyle();i?document.head.replaceChild(n,i):document.head.append(n)}}document.addEventListener("DOMContentLoaded",customElements.define("wijit-code",WijitCode));
