<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Integration Tests</title>
	<style>
		#container {
			height: calc(100vmin - 200px);
			border: 1px solid gray;
			overflow: auto;
		}

		h1 {
			font-size: 18px;
			margin: 0;
		}

		label { display: block; }
	</style>
</head>
<body>
	<h1>Testing all possible attribute combinations and submitting to test server</h1>
	<p>
		<label><span id="current">1</span> of <span id="total">x</span></label>
		<progress id="progress" min="0"></progress>
	</p>
	<p>
		<button onclick="start()">Start</button>
		<button onclick="stop()">Stop</button>
		<button id="pause-button" onclick="pause()">Pause</button>
	</p>
	<div id="container"></div>

	<script type="module">
		import WijitForm from "/wijit-form.js";
		import Tester from "/tester.js";

		let tester, instance, combos;
		let endTest = false;
		let paused = false;
		const abortController = new AbortController();
		const pauseBtn = document.querySelector('#pause-button')
		const progress = document.querySelector('#progress');
		const totalElem = document.querySelector('#total');

		const options = {
			"fetch-options": [null, '{mode:same-origin}'],
			success: [null, '<b>user success msg</b>', '<b>user success with placeholder</b>{{data.name}}'],
			error: [null, '<b>user error msg</b>', '<b>user error with placeholder</b>{{data.name}}'],
			response: ['html', 'json'],
			"force-error": ['true', 'false'],
			modal: ['true', 'false'],
			reset: ['true', 'false']
		};

		function start () {
			const component = new WijitForm();
			const event = new CustomEvent('testEvent', {bubbles:true, cancelable:true, composed:true});
			const form = document.createElement('form');
			const input = document.createElement('input');

			tester = new Tester(component);
			instance = tester.instance;
			combos = tester.getAllCombinations(options);
			progress.setAttribute('max', combos.length);
			totalElem.innerText = combos.length;
			form.action = '/test-server.php';
			input.name = 'name';
			input.value = 'Foobar';
			form.append(input);
			instance.append(form);
			instance.testing = true;
			document.body.append(instance);
			form.dispatchEvent(event)
			form.addEventListener('testEvent', testFormSubmission(event), {signal: abortController.signal});
		}

		function stop () {
			abortController.abort();
			endTest = true;
		}

		function pause() {
			paused = !paused;
			pauseBtn.textContent = paused ? 'Resume' : 'Pause';
		}

		async function pauseIfNeeded() {
			if (paused) {
				await new Promise (resolve => {
					pauseBtn.addEventListener('click', resolve);
				});
				paused = false;
			}
		}

		function updateProgress(count) {
			const label = document.querySelector('#current');
			progress.value = count;
			label.innerText = count;
		}

		function addResult(result, combo, current) {
			const div = document.querySelector('#container');
			const attrs = JSON.stringify(combo);
			div.insertAdjacentHTML('afterbegin', '<hr>');
			div.insertAdjacentHTML('afterbegin', attrs);
			div.insertAdjacentHTML('afterbegin', `<b>${current}</b>`);
			div.insertAdjacentHTML('afterbegin', result);
			document.body.append(div);
		}

		async function testFormSubmission(event) {
			let i = 1;
			for (const combo of combos) {
				// if (combo['force-error'] === 'false') continue;
				if (endTest) break;
				await pauseIfNeeded();
				tester.setAttributes(combo);
				const result = await instance.submitData(event);
				delete(combo.fetchOptionss);
				delete(combo.waiting);
				delete(combo.modal);
				delete(combo.reset);
				addResult(result, combo, i);
				updateProgress(i);
				i++;
			}
		}

		window.start = start;
		window.stop = stop;
		window.pause = pause;
	</script>
</body>
</html>
